<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Study Planner</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <nav class="navbar glass">
    <div class="navbar-left">
      <a href="index.html"><img alt="Logo" class="logo-img" src="logo.jpg"/></a>
    </div>
    <div class="navbar-menu">
      <a href="services.html" id="menu-purchase">구매</a>
      <a href="student_manage.html" id="menu-student-manage">학생 관리</a>
      <a href="support.html" id="menu-support">고객 지원</a>
      <a href="consulting.html" id="menu-consulting">컨설팅</a>
      <a href="admissions.html" id="menu-admission">입시</a>
      <select id="lang-toggle">
        <option value="en">EN</option>
        <option value="ko">KR</option>
      </select>
    </div>
  </nav>

  <div class="container">
    <div id="signin-container">
      <h2>Sign in to Your Study Planner</h2>
      <button id="signin-button">
        <i class="fab fa-google"></i> Sign in with Google
      </button>
    </div>

    <div id="dashboard" class="hidden">
      <h2 id="user-greeting" class="text-center"></h2>

      <!-- ===== ADMIN PANEL ===== -->
      <div id="admin-panel" class="hidden">
        <h3>Admin Panel</h3>
        
        <!-- Time Slot Management -->
        <div class="panel-section">
            <h4>Weekly Time Slot Management</h4>
            <p>Add time slots for each day of the week:</p>
            <label for="day-select">Day:</label>
            <select id="day-select">
              <option value="Monday">Monday</option>
              <option value="Tuesday">Tuesday</option>
              <option value="Wednesday">Wednesday</option>
              <option value="Thursday">Thursday</option>
              <option value="Friday">Friday</option>
              <option value="Saturday">Saturday</option>
              <option value="Sunday">Sunday</option>
            </select>
            <label for="start-time">Start Time:</label>
            <input type="time" id="start-time">
            <label for="end-time">End Time:</label>
            <input type="time" id="end-time">
            <button id="add-time-slot">Add Time Slot</button>
        </div>

        <!-- Calendar Write Access for Admin -->
        <div class="panel-section">
            <h4>Create Calendar Event</h4>
            <input type="text" id="event-summary" placeholder="Event Title">
            <label for="event-start-time">Start Time:</label>
            <input type="datetime-local" id="event-start-time">
            <label for="event-end-time">End Time:</label>
            <input type="datetime-local" id="event-end-time">
            <button id="add-event-button">Add Event to Calendar</button>
        </div>

        <!-- Drive Write Access -->
        <div class="panel-section">
            <h4>Upload to Google Drive</h4>
            <input type="file" id="admin-file-upload">
            <button id="admin-upload-button">Upload File</button>
        </div>
      </div>

      <!-- ===== STUDENT PANEL ===== -->
      <div id="student-panel" class="hidden">
        <h3>Student Panel</h3>
        
        <!-- Drive Write Access -->
        <div class="panel-section">
            <h4>Upload to Google Drive</h4>
            <input type="file" id="student-file-upload">
            <button id="student-upload-button">Upload File</button>
        </div>
      </div>

      <!-- ===== SHARED PANELS (Visible to all signed-in users) ===== -->
      <div id="shared-panels">
        <!-- Google Drive Files (Read) -->
        <div id="drive-files" class="panel-section">
          <h4>My Google Drive Files</h4>
          <ul id="drive-files-list"></ul>
        </div>

        <!-- Google Calendar Events (Read) -->
        <div id="calendar-events" class="panel-section">
          <h4>Upcoming Google Calendar Events</h4>
          <ul id="calendar-events-list"></ul>
        </div>

        <!-- Weekly Scheduler Table -->
        <div id="weekly-scheduler" class="panel-section">
          <h4>Weekly Schedule</h4>
          <table id="scheduler-table">
            <!-- Table generated by JS -->
          </table>
          <button id="auto-generate-slots">Auto-Generate Study Slots</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const CLIENT_ID = '844865657526-h7akmduv1e0fns71h3d72a88t1t2718u.apps.googleusercontent.com'; // Replace with your client ID
    
    // ===== KEY CHANGE: UPDATED SCOPES =====
    // 'drive' scope allows read and write.
    // 'calendar' scope allows read and write.
    // We will control write access via the UI based on user role.
    const SCOPES = [
      'https://www.googleapis.com/auth/drive',
      'https://www.googleapis.com/auth/calendar',
      'https://www.googleapis.com/auth/userinfo.profile',
      'https://www.googleapis.com/auth/userinfo.email'
    ];
    const ADMIN_EMAILS = ["geneheo21@gmail.com", "hifsteamedu@gmail.com"];

    // State variables
    let isSignedIn = false;
    let userEmail = null;
    let isAdmin = false;
    let timeSlots = { Monday: [], Tuesday: [], Wednesday: [], Thursday: [], Friday: [], Saturday: [], Sunday: [] };

    // DOM elements
    const signinContainer = document.getElementById('signin-container');
    const signinButton = document.getElementById('signin-button');
    const dashboard = document.getElementById('dashboard');
    const userGreeting = document.getElementById('user-greeting');
    const adminPanel = document.getElementById('admin-panel');
    const studentPanel = document.getElementById('student-panel');
    const driveFilesList = document.getElementById('drive-files-list');
    const calendarEventsList = document.getElementById('calendar-events-list');
    const schedulerTable = document.getElementById('scheduler-table');
    const autoGenerateSlotsButton = document.getElementById('auto-generate-slots');
    const daySelect = document.getElementById('day-select');
    const startTimeInput = document.getElementById('start-time');
    const endTimeInput = document.getElementById('end-time');
    const addTimeSlotButton = document.getElementById('add-time-slot');
    const addEventButton = document.getElementById('add-event-button');
    const adminUploadButton = document.getElementById('admin-upload-button');
    const studentUploadButton = document.getElementById('student-upload-button');


    // Initialize Google API client
    function initClient() {
      gapi.load('client:auth2', () => {
        gapi.client.init({
          clientId: CLIENT_ID,
          scope: SCOPES.join(' ')
        }).then(() => {
          const authInstance = gapi.auth2.getAuthInstance();
          isSignedIn = authInstance.isSignedIn.get();
          updateSigninStatus(isSignedIn);
          authInstance.isSignedIn.listen(updateSigninStatus);
        }).catch(error => {
          console.error('Error initializing Google API client:', error);
          alert('Failed to initialize Google API. Check console for details.');
        });
      });
    }

    // Update sign-in status
    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        userEmail = gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile().getEmail();
        isAdmin = ADMIN_EMAILS.includes(userEmail);
        showDashboard();
        loadGoogleDriveFiles();
        loadGoogleCalendarEvents();
        generateSchedulerTable();
      } else {
        hideDashboard();
      }
    }

    // Sign-in function
    function signIn() {
      gapi.auth2.getAuthInstance().signIn();
    }

    // Show/Hide UI based on role
    function showDashboard() {
      signinContainer.classList.add('hidden');
      dashboard.classList.remove('hidden');
      userGreeting.textContent = `Hello, ${gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile().getName()}!`;

      if (isAdmin) {
        adminPanel.classList.remove('hidden');
        studentPanel.classList.add('hidden');
      } else {
        adminPanel.classList.add('hidden');
        studentPanel.classList.remove('hidden');
      }
    }

    function hideDashboard() {
      signinContainer.classList.remove('hidden');
      dashboard.classList.add('hidden');
    }

    // ===== GOOGLE DRIVE FUNCTIONS (READ & WRITE) =====
    function loadGoogleDriveFiles() {
      gapi.client.drive.files.list({
        pageSize: 10,
        fields: "files(id, name, webViewLink)",
      }).then(response => {
        const files = response.result.files;
        driveFilesList.innerHTML = '';
        if (files && files.length > 0) {
          files.forEach(file => {
            const listItem = document.createElement('li');
            listItem.innerHTML = `<a href="${file.webViewLink}" target="_blank">${file.name}</a>`;
            driveFilesList.appendChild(listItem);
          });
        } else {
          driveFilesList.textContent = 'No files found.';
        }
      });
    }

    function uploadFile(file) {
        if (!file) {
            alert("Please select a file to upload.");
            return;
        }
        const metadata = {
            'name': file.name,
            'mimeType': file.type
        };
        const reader = new FileReader();
        reader.readAsBinaryString(file);
        reader.onload = () => {
            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const close_delim = "\r\n--" + boundary + "--";

            const body = delimiter +
                'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                JSON.stringify(metadata) +
                delimiter +
                'Content-Type: ' + file.type + '\r\n' +
                'Content-Transfer-Encoding: base64\r\n\r\n' +
                btoa(reader.result) +
                close_delim;

            gapi.client.request({
                'path': 'https://www.googleapis.com/upload/drive/v3/files',
                'method': 'POST',
                'params': {'uploadType': 'multipart'},
                'headers': {
                    'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                },
                'body': body
            }).then(response => {
                alert('File uploaded successfully!');
                console.log(response);
                loadGoogleDriveFiles(); // Refresh the file list
            }).catch(err => {
                console.error("Error uploading file:", err);
                alert("File upload failed. See console for details.");
            });
        };
    }


    // ===== GOOGLE CALENDAR FUNCTIONS (READ & WRITE) =====
    function loadGoogleCalendarEvents() {
      gapi.client.calendar.events.list({
        calendarId: 'primary',
        timeMin: (new Date()).toISOString(),
        showDeleted: false,
        singleEvents: true,
        maxResults: 10,
        orderBy: 'startTime'
      }).then(response => {
        const events = response.result.items;
        calendarEventsList.innerHTML = '';
        if (events && events.length > 0) {
          events.forEach(event => {
            const start = event.start.dateTime || event.start.date;
            const listItem = document.createElement('li');
            listItem.textContent = `${event.summary} (${new Date(start).toLocaleString()})`;
            calendarEventsList.appendChild(listItem);
          });
        } else {
          calendarEventsList.textContent = 'No upcoming events found.';
        }
      });
    }

    // This function is only callable by an admin via the UI
    function createCalendarEvent() {
        const summary = document.getElementById('event-summary').value;
        const startTime = document.getElementById('event-start-time').value;
        const endTime = document.getElementById('event-end-time').value;

        if (!summary || !startTime || !endTime) {
            alert("Please fill out all event fields.");
            return;
        }

        const event = {
            'summary': summary,
            'start': {
                'dateTime': new Date(startTime).toISOString(),
                'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone
            },
            'end': {
                'dateTime': new Date(endTime).toISOString(),
                'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone
            }
        };

        const request = gapi.client.calendar.events.insert({
            'calendarId': 'primary',
            'resource': event
        });

        request.execute(event => {
            alert('Event created: ' + event.htmlLink);
            loadGoogleCalendarEvents(); // Refresh the event list
        });
    }


    // ===== SCHEDULER TABLE LOGIC (Unchanged) =====
    function generateSchedulerTable() {
      const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
      let tableHTML = `
        <thead>
          <tr>
            <th>Time</th>
            ${days.map(day => `<th>${day}</th>`).join('')}
          </tr>
        </thead>
        <tbody>
      `;
      let allTimes = [];
      days.forEach(day => {
        timeSlots[day].forEach(slot => {
          if (!allTimes.find(time => time.start === slot.start && time.end === slot.end)) {
            allTimes.push({ start: slot.start, end: slot.end });
          }
        });
      });
      allTimes.sort((a, b) => a.start.localeCompare(b.start));
      allTimes.forEach(time => {
        tableHTML += `
          <tr>
            <td>${time.start} - ${time.end}</td>
            ${days.map(day => {
              const slot = timeSlots[day].find(s => s.start === time.start && s.end === time.end);
              const task = slot ? slot.task || '' : '';
              return `
                <td>
                  <select class="task-select" data-day="${day}" data-start="${time.start}" data-end="${time.end}">
                    <option value="">Select Task</option>
                    <option value="Math" ${task === 'Math' ? 'selected' : ''}>Math</option>
                    <option value="Science" ${task === 'Science' ? 'selected' : ''}>Science</option>
                    <option value="English" ${task === 'English' ? 'selected' : ''}>English</option>
                    <option value="History" ${task === 'History' ? 'selected' : ''}>History</option>
                    <option value="Study Alone" ${task === 'Study Alone' ? 'selected' : ''}>Study Alone</option>
                  </select>
                </td>
              `;
            }).join('')}
          </tr>
        `;
      });
      tableHTML += `</tbody>`;
      schedulerTable.innerHTML = tableHTML;
    }

    // Event listeners
    signinButton.addEventListener('click', signIn);
    addTimeSlotButton.addEventListener('click', function() {
      const day = daySelect.value;
      const start = startTimeInput.value;
      const endTime = endTimeInput.value;
      if (start && endTime) {
        timeSlots[day].push({ start: start, end: endTime });
        generateSchedulerTable();
      } else {
        alert('Please enter both start and end times.');
      }
    });

    // New event listeners for write actions
    addEventButton.addEventListener('click', createCalendarEvent);
    adminUploadButton.addEventListener('click', () => {
        const file = document.getElementById('admin-file-upload').files[0];
        uploadFile(file);
    });
    studentUploadButton.addEventListener('click', () => {
        const file = document.getElementById('student-file-upload').files[0];
        uploadFile(file);
    });


    // Initialize on page load
    initClient();
  </script>

  <script async defer src="https://apis.google.com/js/api.js"
    onload="this.onload=function(){};gapi.load('client:auth2', initClient);">
  </script>
</body>
</html>